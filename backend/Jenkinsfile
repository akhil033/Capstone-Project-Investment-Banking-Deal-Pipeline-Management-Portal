pipeline {
    agent any
    
    tools {
        maven 'Maven-3.9'
    }
    
    environment {
        DOCKER_IMAGE = 'deal-pipeline-backend'
        DOCKER_TAG = "${BUILD_NUMBER}"
        EC2_HOST = 'ec2-54-237-217-31.compute-1.amazonaws.com' 
        EC2_USER = 'ec2-user'
        AWS_REGION = 'us-east-1'
    }
    
    stages {
        stage('Checkout') {
            steps {
                echo 'Checking out code from GitHub...'
                checkout scm
            }
        }
        
        stage('Build & Test') {
            steps {
                dir('backend') {
                    echo 'Running Maven build and tests...'
                    sh 'mvn clean test'
                    
                    echo 'Packaging application...'
                    sh 'mvn package -DskipTests'
                }
            }
            post {
                always {
                    junit 'backend/target/surefire-reports/*.xml'
                    jacoco(
                        execPattern: 'backend/target/jacoco.exec',
                        classPattern: 'backend/target/classes',
                        sourcePattern: 'backend/src/main/java'
                    )
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                dir('backend') {
                    echo 'Building Docker image...'
                    sh "docker build -t ${DOCKER_IMAGE}:${DOCKER_TAG} ."
                    sh "docker tag ${DOCKER_IMAGE}:${DOCKER_TAG} ${DOCKER_IMAGE}:latest"
                }
            }
        }
        
        stage('Deploy to EC2') {
            steps {
                echo 'Deploying to EC2...'
                sshagent(credentials: ['ec2-ssh-key']) {
                    // Save Docker image as tar
                    sh "docker save ${DOCKER_IMAGE}:latest | gzip > backend-image.tar.gz"
                    
                    // Copy image to EC2
                    sh """
                        scp -o StrictHostKeyChecking=no \
                            backend-image.tar.gz \
                            ${EC2_USER}@${EC2_HOST}:~/
                    """
                    
                    // Deploy on EC2
                    withCredentials([string(credentialsId: 'mongodb-connection-string', variable: 'MONGO_URI')]) {
                        sh """
                            ssh -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} '
                                # Load image
                                docker load < ~/backend-image.tar.gz
                                
                                # Stop and remove old container
                                docker stop deal-pipeline-backend || true
                                docker rm deal-pipeline-backend || true
                                
                                # Run new container
                                docker run -d \
                                    --name deal-pipeline-backend \
                                    --restart unless-stopped \
                                    -p 8080:8080 \
                                    -e SPRING_DATA_MONGODB_URI="${MONGO_URI}" \
                                    -e SPRING_PROFILES_ACTIVE=production \
                                    ${DOCKER_IMAGE}:latest
                                
                                # Clean up
                                rm ~/backend-image.tar.gz
                                docker image prune -f
                            '
                        """
                    }
                }
            }
        }
        
        stage('Health Check') {
            steps {
                echo 'Performing health check...'
                script {
                    sleep(time: 15, unit: 'SECONDS')
                    
                    def response = sh(
                        script: "curl -s -o /dev/null -w '%{http_code}' http://${EC2_HOST}:8080/api/auth/login",
                        returnStdout: true
                    ).trim()
                    
                    if (response != '200' && response != '405') {
                        error "Health check failed with status: ${response}"
                    }
                    echo "Health check passed with status: ${response}"
                }
            }
        }
    }
    
    post {
        success {
            echo 'Backend deployment successful!'
            echo "Backend URL: http://${EC2_HOST}:8080"
        }
        failure {
            echo 'Backend deployment failed!'
        }
        always {
            // Clean up local images
            sh "docker rmi ${DOCKER_IMAGE}:${DOCKER_TAG} || true"
            sh "rm -f backend-image.tar.gz"
        }
    }
}
